<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pac-Man-2</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      background: black;
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

let width = window.innerWidth;
let height = window.innerHeight;
canvas.width = width;
canvas.height = height;

const TILE = 40;
const ROWS = Math.floor(height / TILE);
const COLS = Math.floor(width / TILE);

let map = [];

for (let row = 0; row < ROWS; row++) {
  map[row] = [];
  for (let col = 0; col < COLS; col++) {
    if (row === 0 || row === ROWS - 1 || col === 0 || col === COLS - 1) {
      map[row][col] = 1;
    } else {
      map[row][col] = (row === 1 || row === ROWS - 2 || col % 4 === 0) ? 1 : 0;
    }
  }
}

const player = {
  x: TILE * 1,
  y: TILE * 1,
  dx: 0,
  dy: 0,
  speed: 2,
  size: TILE * 0.8,
  power: false,
  powerTime: 0
};

const ghost = {
  x: TILE * (COLS - 3),
  y: TILE * 1,
  dx: 0,
  dy: 0,
  speed: 2,
  size: TILE * 0.8
};

let hearts = [];
function spawnHeart() {
  let x, y;
  do {
    x = Math.floor(Math.random() * COLS);
    y = 1; // Apenas linha 0 (ajustado para y=1 por causa das paredes)
  } while (map[y][x] === 1 || Math.abs(player.x - x * TILE) < TILE * 5);
  hearts.push({ x: x * TILE + TILE / 4, y: y * TILE + TILE / 4 });
  setTimeout(spawnHeart, 15000);
}
spawnHeart();

function drawTile(x, y, color) {
  ctx.fillStyle = color;
  ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
}

function drawMap() {
  for (let row = 0; row < ROWS; row++) {
    for (let col = 0; col < COLS; col++) {
      if (map[row][col] === 1) {
        drawTile(col, row, 'blue');
      }
    }
  }
}

function drawPlayer() {
  ctx.fillStyle = player.power ? 'orange' : 'yellow';
  ctx.beginPath();
  ctx.arc(player.x + TILE / 2, player.y + TILE / 2, player.size / 2, 0, Math.PI * 2);
  ctx.fill();
}

function drawGhost() {
  ctx.fillStyle = player.power ? 'lightblue' : 'white';
  ctx.beginPath();
  ctx.arc(ghost.x + TILE / 2, ghost.y + TILE / 2, ghost.size / 2, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = 'black';
  ctx.font = '20px Arial';
  ctx.fillText('ðŸ‘»', ghost.x + TILE / 4, ghost.y + TILE * 0.75);
}

function drawHearts() {
  ctx.font = '30px Arial';
  hearts.forEach(h => ctx.fillText('ðŸ¤Ž', h.x, h.y));
}

function isWall(x, y) {
  const row = Math.floor(y / TILE);
  const col = Math.floor(x / TILE);
  return map[row]?.[col] === 1;
}

function moveCharacter(character) {
  const nextX = character.x + character.dx;
  const nextY = character.y + character.dy;
  if (!isWall(nextX, nextY) && !isWall(nextX + character.size, nextY + character.size)) {
    character.x = nextX;
    character.y = nextY;
  }
}

function updateGhostAI() {
  const dx = player.x - ghost.x;
  const dy = player.y - ghost.y;
  ghost.dx = dx === 0 ? 0 : dx > 0 ? ghost.speed : -ghost.speed;
  ghost.dy = dy === 0 ? 0 : dy > 0 ? ghost.speed : -ghost.speed;
  if (Math.abs(dx) > Math.abs(dy)) ghost.dy = 0;
  else ghost.dx = 0;
}

function checkCollision(a, b) {
  return (
    a.x < b.x + TILE &&
    a.x + TILE > b.x &&
    a.y < b.y + TILE &&
    a.y + TILE > b.y
  );
}

function gameLoop() {
  ctx.clearRect(0, 0, width, height);
  drawMap();
  drawPlayer();
  drawGhost();
  drawHearts();

  moveCharacter(player);
  moveCharacter(ghost);

  updateGhostAI();

  hearts = hearts.filter(h => {
    if (checkCollision(player, h)) {
      player.power = true;
      player.powerTime = 600;
      return false;
    }
    return true;
  });

  if (player.power) {
    player.powerTime--;
    if (player.powerTime <= 0) player.power = false;
  }

  if (checkCollision(player, ghost)) {
    if (player.power) {
      const r = confirm('VocÃª venceu! Quer aceitar o pedido?');
      if (r) window.close();
      else player.power = false;
    } else {
      alert('JÃ¡ que vocÃª perdeu, tem que aceitar.');
      window.close();
    }
  }

  requestAnimationFrame(gameLoop);
}

gameLoop();

document.addEventListener('keydown', e => {
  if (e.key === 'w') { player.dy = -player.speed; player.dx = 0; }
  if (e.key === 's') { player.dy = player.speed; player.dx = 0; }
  if (e.key === 'a') { player.dx = -player.speed; player.dy = 0; }
  if (e.key === 'd') { player.dx = player.speed; player.dy = 0; }
});

document.addEventListener('keyup', e => {
  if (['w', 's'].includes(e.key)) player.dy = 0;
  if (['a', 'd'].includes(e.key)) player.dx = 0;
});
</script>
</body>
</html>